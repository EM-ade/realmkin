rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Admin configuration - stored in Firestore for easier management
    match /adminConfig/{configId} {
      // Keep the admin rule as is since it works
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    // Users collection with wallet-based access control
    match /users/{userId} {
      // Allow read access to user data
      allow read: if true;

      // Allow write access to user data
      allow write: if true;
    }

    // Usernames collection with wallet-based access
    match /usernames/{username} {
      // Anyone can check if a username document exists (for availability checks).
      allow get: if true;
      allow list: if false; // Prevent listing all usernames

      // Allow username creation
      allow create: if request.resource.data.walletAddress != null &&
                      request.resource.data.walletAddress.size() >= 32 &&
                      request.resource.data.walletAddress.size() <= 44 &&
                      request.resource.data.walletAddress.matches('^[A-Za-z0-9]+$') &&
                      // Validate username format from the document ID
                      username.size() >= 3 &&
                      username.size() <= 20 &&
                      username.matches('^[a-zA-Z0-9_]+$');

      // Allow read and update of username documents
      allow read, update: if true;
    }

    // Wallets collection with access control
    match /wallets/{walletAddress} {
      // Allow reads for existence checks and UID lookup
      allow read: if true;

      // Allow wallet creation
      allow create: if walletAddress.size() >= 32 &&
                      walletAddress.size() <= 44 &&
                      walletAddress.matches('^[A-Za-z0-9]+$') &&
                      request.resource.data.uid != null;
    }

    // User rewards collection
    match /userRewards/{userId} {
      // Allow access to user rewards
      allow read, write: if true;
    }

    // Claim records collection
    match /claimRecords/{claimId} {
      // Allow read access to claim records
      allow read: if true;
      // Writes are disabled from the client-side.
      allow write: if false;
    }

    // Rate limiting collection
    match /rateLimits/{userId} {
      // Only server-side functions can access this collection.
      allow read, write: if false;
    }
  }
}